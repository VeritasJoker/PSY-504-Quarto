{
  "hash": "82b869b2b4f36fee8080ba3e6573da1a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab: Poisson Regression\"\nsubtitle: \"Princeton University\"\ndate: \"2025-03-05\"\nauthor: \"KW\"\ncategories: [code, analysis]\nformat:\n  html:\n    self-contained: true\n    anchor-sections: true\n    code-tools: true\n    code-fold: true\n    fig-width: 8\n    fig-height: 4\n    code-block-bg: \"#f1f3f5\"\n    code-block-border-left: \"#31BAE9\"\n    mainfont: Source Sans Pro\n    theme: journal\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    captions: true\n    cap-location: margin\n    table-captions: true\n    tbl-cap-location: margin\n    reference-location: margin\n  pdf:\n    pdf-engine: lualatex\n    toc: false\n    number-sections: true\n    number-depth: 2\n    top-level-division: section\n    reference-location: document\n    listings: false\n    header-includes:\n      \\usepackage{marginnote, here, relsize, needspace, setspace}\n      \\def\\it{\\emph}\nexecute:\n  freeze: auto\n  echo: true\n  message: false\n  warning: false\n  fig-align: center\n  fig-width: 12\n  fig-height: 8\n  editor_options: \n  chunk_output_type: inline\n  code-overflow: wrap\n  html:\n    code-fold: true\n    code-tools: true\n---\n\n\n\n1.  To complete this lab:\n\n-   Load packages\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\nlibrary(tidyverse)\nlibrary(emmeans)\nlibrary(ggeffects)\nlibrary(easystats)\nlibrary(performance)\nlibrary(knitr)\n```\n:::\n\n\n\n-   Download the dataset:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\ndata <- read_delim(\"https://raw.githubusercontent.com/jgeller112/psy504-advanced-stats/main/slides/Poisson/data/2010.csv\")\n```\n:::\n\n\n\n2.  Conduct the analysis described in the preregistration document\n\n<!-- -->\n\na.  The number of hours per week that a person spends on the Internet (\"WWWHR\") will\\\n    be predicted by their vocabulary (\"WORDSUM\"), age (\"AGE\"), sex (\"SEX\"), religiosity\\\n    (\"RELITEN\"), political orientation (\"POLVIEWS\"), and how often they work from home\\\n    (\"WRKHOME\").\n\n-   Let's use the `naniar` package's function `replace_with_na`to clean the data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(naniar)\n\ndata_pos <- data %>%\n  dplyr::select(wwwhr, wordsum, age, sex, reliten, polviews, wrkhome) %>%\nreplace_with_na(.,\n             replace = list(wwwhr = c(-1, 998, 999),\n                          wordsum = c(-1, 99),\n                          reliten = c(0, 8, 9), \n             polviews = c(0, 8, 9), \n             wrkhome = c(0,8,9), \n             age=c(0, 98, 99)))\n```\n:::\n\n\n\nQ: Can you explain what might be going on in the above code?\n\nA: The code is using `dplyr` package to select 7 columns, then replace the values specified in the list with NAs. For instance, it replaces `wwwhr` values -1, 998, and 999 to NAs.\n\nQ: The next step in data cleaning would be to ensure that the data in your code are aligned with the description/ usage context of the variables\n\n-   Recode sex and reliten as necessary\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_pos = data_pos %>%\n  mutate(age_recode = age - mean(age, na.rm=TRUE),\n         sex_recode = as.factor(sex),\n         reliten_recode = as.factor(reliten),\n         polviews_recode = as.factor(polviews),\n         wrkhome_recode = as.factor(wrkhome))\n```\n:::\n\n\n\n## Missingness\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_pos %>%\n  dplyr::select(reliten, reliten_recode)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2,044 x 2\n   reliten reliten_recode\n     <dbl> <fct>         \n 1       1 1             \n 2       4 4             \n 3       1 1             \n 4       1 1             \n 5       1 1             \n 6       4 4             \n 7       3 3             \n 8       1 1             \n 9       1 1             \n10       1 1             \n# i 2,034 more rows\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(skimr)\nskimr::skim(data_pos)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |         |\n|:------------------------|:--------|\n|Name                     |data_pos |\n|Number of rows           |2044     |\n|Number of columns        |12       |\n|_______________________  |         |\n|Column type frequency:   |         |\n|factor                   |4        |\n|numeric                  |8        |\n|________________________ |         |\n|Group variables          |None     |\n\n\n**Variable type: factor**\n\n|skim_variable   | n_missing| complete_rate|ordered | n_unique|top_counts                     |\n|:---------------|---------:|-------------:|:-------|--------:|:------------------------------|\n|sex_recode      |         0|          1.00|FALSE   |        2|-1: 1153, 1: 891               |\n|reliten_recode  |        99|          0.95|FALSE   |        4|2: 747, 1: 707, 4: 363, 3: 128 |\n|polviews_recode |        71|          0.97|FALSE   |        7|4: 746, 6: 315, 5: 265, 2: 259 |\n|wrkhome_recode  |       882|          0.57|FALSE   |        6|1: 674, 5: 147, 2: 101, 4: 92  |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|  mean|    sd|     p0|    p25|   p50|   p75|   p100|hist  |\n|:-------------|---------:|-------------:|-----:|-----:|------:|------:|-----:|-----:|------:|:-----|\n|wwwhr         |       996|          0.51|  9.79| 13.41|   0.00|   2.00|  5.00| 14.00| 168.00|▇▁▁▁▁ |\n|wordsum       |       657|          0.68|  6.03|  2.07|   0.00|   5.00|  6.00|  7.00|  10.00|▁▃▇▅▂ |\n|age           |         3|          1.00| 47.97| 17.68|  18.00|  33.00| 47.00| 61.00|  89.00|▇▇▇▅▃ |\n|sex           |         0|          1.00| -0.13|  0.99|  -1.00|  -1.00| -1.00|  1.00|   1.00|▇▁▁▁▆ |\n|reliten       |        99|          0.95|  2.08|  1.08|   1.00|   1.00|  2.00|  3.00|   4.00|▇▇▁▂▃ |\n|polviews      |        71|          0.97|  4.08|  1.46|   1.00|   3.00|  4.00|  5.00|   7.00|▃▂▇▃▅ |\n|wrkhome       |       882|          0.57|  2.26|  1.72|   1.00|   1.00|  1.00|  4.00|   6.00|▇▁▁▂▁ |\n|age_recode    |         3|          1.00|  0.00| 17.68| -29.97| -14.97| -0.97| 13.03|  41.03|▇▇▇▅▃ |\n\n\n:::\n:::\n\n\n\n## Fit a Poisson model to the data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\nmodel1 = glm(wwwhr~age_recode+wordsum+sex_recode+reliten_recode+polviews_recode+wrkhome_recode, \n              data=data_pos,\n              family=poisson(link = \"log\"))\n```\n:::\n\n\n\n## Carry out model checking\n\nHint: performance package has the function you're looking for\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(performance)\nperformance::check_model(model1, check = c(\"pp_check\", \"outliers\", \"vif\", \"overdispersion\"))\n```\n\n::: {.cell-output-display}\n![](poisson_lab_questions-1_files/figure-pdf/unnamed-chunk-7-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Find any outliers\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noutlier_idx = check_outliers(model1)\noutlier_idx\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n3 outliers detected: cases 72, 156, 363.\n- Based on the following method and threshold: cook (0.8).\n- For variable: (Whole model).\n```\n\n\n:::\n:::\n\n\n\n## Refit the model after excluding outliers\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_pos2 = data_pos %>%\n  filter(! row_number() %in% which(outlier_idx))\n\nmodel2 = glm(wwwhr~age+wordsum+sex_recode+reliten_recode+polviews_recode+wrkhome_recode, \n              data=data_pos2,\n              family=poisson(link=\"log\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_parameters(model2) %>%\n  print_html()\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{tabular*}{\\linewidth}{@{\\extracolsep{\\fill}}lccccc}\n\\toprule\nParameter & Coefficient & SE & 95\\% CI & z & p \\\\ \n\\midrule\\addlinespace[2.5pt]\n{(Intercept)} & 1.89 & 0.09 & (1.71, 2.07) & 20.52 & < .001 \\\\ \n{age} & -0.02 & 1.10e-03 & (-0.02, -0.01) & -15.29 & < .001 \\\\ \n{wordsum} & 0.10 & 7.86e-03 & (0.08, 0.11) & 12.38 & < .001 \\\\ \n{sex recode (1)} & 0.22 & 0.03 & (0.17, 0.27) & 8.13 & < .001 \\\\ \n{reliten recode (2)} & 0.34 & 0.04 & (0.26, 0.41) & 8.88 & < .001 \\\\ \n{reliten recode (3)} & 0.43 & 0.06 & (0.30, 0.55) & 6.68 & < .001 \\\\ \n{reliten recode (4)} & 0.65 & 0.04 & (0.57, 0.72) & 16.23 & < .001 \\\\ \n{polviews recode (2)} & -0.10 & 0.07 & (-0.23, 0.03) & -1.49 & 0.136  \\\\ \n{polviews recode (3)} & -0.18 & 0.07 & (-0.31, -0.04) & -2.51 & 0.012  \\\\ \n{polviews recode (4)} & -0.21 & 0.06 & (-0.33, -0.08) & -3.23 & 0.001  \\\\ \n{polviews recode (5)} & -0.06 & 0.07 & (-0.19, 0.07) & -0.92 & 0.359  \\\\ \n{polviews recode (6)} & -0.25 & 0.07 & (-0.39, -0.11) & -3.46 & < .001 \\\\ \n{polviews recode (7)} & -0.31 & 0.10 & (-0.51, -0.11) & -3.02 & 0.003  \\\\ \n{wrkhome recode (2)} & 0.21 & 0.04 & (0.12, 0.29) & 4.57 & < .001 \\\\ \n{wrkhome recode (3)} & 0.35 & 0.05 & (0.26, 0.44) & 7.50 & < .001 \\\\ \n{wrkhome recode (4)} & 0.44 & 0.04 & (0.35, 0.52) & 9.76 & < .001 \\\\ \n{wrkhome recode (5)} & 0.24 & 0.04 & (0.15, 0.32) & 5.64 & < .001 \\\\ \n{wrkhome recode (6)} & 0.40 & 0.06 & (0.29, 0.51) & 7.20 & < .001 \\\\ \n\\bottomrule\n\\end{tabular*}\n\\begin{minipage}{\\linewidth}\n\\\\\n\\end{minipage}\n\\end{table}\n\n:::\n:::\n\n\n\n### Check for Overdispersion\n\nHint: performance package has the function you're looking for\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperformance::check_overdispersion(model2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Overdispersion test\n\n       dispersion ratio =   15.102\n  Pearson's Chi-Squared = 8804.224\n                p-value =  < 0.001\n```\n\n\n:::\n:::\n\n\n\nWhat do you notice? And what's a good next step forward? Can there be another model class that can fit the data? If so, fit this model to the data.\n\n-   There is overdispersion, which means there is more variation in the response than what's implied by a Poisson model. We can try to fit a negative-binomial regression model.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel3 = glm.nb(wwwhr~age+wordsum+sex_recode+reliten_recode+polviews_recode+wrkhome_recode, \n              data=data_pos2)\n\nmodel4 = MASS::glm.nb(wwwhr~age+wordsum+sex_recode+reliten_recode+polviews_recode+wrkhome_recode, \n              data=data_pos2)\n```\n:::\n\n\n\n## Which one is better- your earlier model, or later model?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_likelihoodratio(model2, model3) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n\n\n|       |Name   |Model  | df| df_diff|     Chi2|  p|\n|:------|:------|:------|--:|-------:|--------:|--:|\n|model2 |model2 |glm    | 18|      NA|       NA| NA|\n|model3 |model3 |negbin | 19|       1| 4510.038|  0|\n\n\n:::\n\n```{.r .cell-code}\ntest_likelihoodratio(model2, model4) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n\n\n|       |Name   |Model  | df| df_diff|     Chi2|  p|\n|:------|:------|:------|--:|-------:|--------:|--:|\n|model2 |model2 |glm    | 18|      NA|       NA| NA|\n|model4 |model4 |negbin | 19|       1| 4510.038|  0|\n\n\n:::\n:::\n\n\n\nThe later model is better here, which means the previous poisson model was not a good fit to the data.\n\n## What is zero inflation? Is there zero-inflation in your chosen model?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperformance::check_zeroinflation(model3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Check for zero-inflation\n\n   Observed zeros: 40\n  Predicted zeros: 67\n            Ratio: 1.68\n```\n\n\n:::\n:::\n\n\n\nThere is no zero-inflation here since \\# of observed zeros \\< \\# of predicted zeros.\n\n::: panel-tabset\n## Log Lambda\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(coef(model4))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     (Intercept)              age          wordsum      sex_recode1 \n      1.72933133      -0.01630350       0.10573220       0.14429163 \n reliten_recode2  reliten_recode3  reliten_recode4 polviews_recode2 \n      0.28114285       0.38546776       0.62578244       0.17573144 \npolviews_recode3 polviews_recode4 polviews_recode5 polviews_recode6 \n      0.09431515      -0.04193018       0.13914802      -0.04427420 \npolviews_recode7  wrkhome_recode2  wrkhome_recode3  wrkhome_recode4 \n     -0.15510946       0.11140958       0.31377893       0.30530537 \n wrkhome_recode5  wrkhome_recode6 \n      0.15257360       0.25947760 \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(exp(coef(model4)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     (Intercept)              age          wordsum      sex_recode1 \n       5.6368834        0.9838287        1.1115242        1.1552210 \n reliten_recode2  reliten_recode3  reliten_recode4 polviews_recode2 \n       1.3246428        1.4703019        1.8697083        1.1921179 \npolviews_recode3 polviews_recode4 polviews_recode5 polviews_recode6 \n       1.0989060        0.9589367        1.1492942        0.9566916 \npolviews_recode7  wrkhome_recode2  wrkhome_recode3  wrkhome_recode4 \n       0.8563214        1.1178527        1.3685871        1.3570393 \n wrkhome_recode5  wrkhome_recode6 \n       1.1648282        1.2962527 \n```\n\n\n:::\n\n```{.r .cell-code}\nmean(exp(predict(model4, type = \"link\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 9.879506\n```\n\n\n:::\n:::\n\n\n\n## Mean Count\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(mean(data_pos2$wwwhr, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 9.792543\n```\n\n\n:::\n\n```{.r .cell-code}\ndata_pos_base = data_pos2 %>%\n  filter(sex_recode==-1, reliten_recode==1, polviews_recode==1, wrkhome_recode==1)\nmean(data_pos_base$wwwhr, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5.4\n```\n\n\n:::\n:::\n\n\n:::\n\n## Report your conclusions\n\nThe coefficients of the model is roughly similar to the log value of the mean of the dependent variable. The exponential of the intercept of the model is 5.637, while the mean number of hours per week that a person spends on the internet (wwwhr) for the baseline group (sex=-1, religosity=1, political_orientation=1, work_from_home=1) is 5.4.\n\nBecause of the numerous number of levels for different categorical variables, here we don't look at each different levels. We can use our full model to predict the dependent variable, and then take the mean of the exponential, which is 9.880, while the mean wwwhr for the whole dataset is 9.793.\n\nOverall, a negative-binomial regression model is a good fit to the data due to dispersion. We don't need to use a zero-inflated model since there is no zero-inflation.\n",
    "supporting": [
      "poisson_lab_questions-1_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{booktabs}\n\\usepackage{caption}\n\\usepackage{longtable}\n\\usepackage{colortbl}\n\\usepackage{array}\n\\usepackage{anyfontsize}\n\\usepackage{multirow}\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}